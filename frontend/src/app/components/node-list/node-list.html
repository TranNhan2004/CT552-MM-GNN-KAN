<!-- components/node-list/node-list.component.html -->
<div>
  <!-- Open Modal Button -->
  <button (click)="openModal()" [disabled]="!result()" class="flex items-center space-x-2 bg-gradient-to-r from-green-300 to-blue-500
           text-white px-5 py-3 rounded-lg shadow-md hover:shadow-lg
           hover:from-green-500 hover:to-blue-700
           transition-all duration-200 transform hover:scale-105 font-medium
           disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none">
    <app-icon name="list-bullet" className="w-5 h-5" />
    <span class="font-bold">Danh sách nút</span>
    @if (getSelectedCount() > 0) {
    <span class="bg-white text-green-600 px-2.5 py-0.5 rounded-full text-xs font-bold">
      {{ getSelectedCount() }}/{{ getTotalCount() }}
    </span>
    }
  </button>

  <!-- Modal -->
  @if (showModal()) {
  <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" (click)="closeModal()">
    <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col"
      (click)="$event.stopPropagation()">
      <!-- Modal Header -->
      <div class="sticky top-0 bg-gradient-to-r from-green-300 via-cyan-400 to-blue-500 px-6 py-5 rounded-t-2xl z-10">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-2xl font-bold text-white">Danh sách các nút</h2>
            <p class="text-white text-sm mt-1 opacity-90">
              Chọn các nút để hiển thị trên đồ thị
            </p>
          </div>
          <button (click)="closeModal()"
            class="text-white hover:bg-blue-200 hover:bg-opacity-20 rounded-full p-2 transition">
            <app-icon name="x-mark" className="w-7 h-7" />
          </button>
        </div>
      </div>

      <!-- Threshold Selection -->
      <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-sm font-semibold text-gray-700 mb-1">Ngưỡng hiển thị cạnh</h3>
            <p class="text-xs text-gray-500">Chỉ hiển thị các cạnh có trọng số cao nhất</p>
          </div>
          <div class="flex space-x-2">
            @for (threshold of thresholds; track threshold) {
            <button (click)="setThreshold(threshold)" [class.bg-gradient-to-r]="selectedThreshold() === threshold"
              [class.from-green-500]="selectedThreshold() === threshold"
              [class.to-blue-600]="selectedThreshold() === threshold"
              [class.text-white]="selectedThreshold() === threshold"
              [class.bg-gray-200]="selectedThreshold() !== threshold"
              [class.text-gray-700]="selectedThreshold() !== threshold"
              class="px-4 py-2 rounded-lg font-semibold transition shadow-sm hover:shadow-md">
              {{ threshold }}%
            </button>
            }
          </div>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="p-6 space-y-6 overflow-auto flex-1">
        <!-- Images Section -->
        <div class="border-2 border-green-200 rounded-xl p-5 bg-gradient-to-br from-green-50 to-blue-100">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-2">
              <app-icon name="photo" className="w-6 h-6 text-green-600" />
              <h3 class="font-bold text-gray-800 text-lg">Ảnh</h3>
              <span class="text-xs bg-white px-2 py-1 rounded-full text-gray-600">
                {{ selectedImageIndices().size }}/{{ getImageCount() }}
              </span>
            </div>
            <div class="flex space-x-2">
              <button (click)="selectAllImages()"
                class="text-xs bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition">
                Chọn tất cả
              </button>
              <button (click)="deselectAllImages()"
                class="text-xs bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500 transition">
                Bỏ chọn
              </button>
            </div>
          </div>

          @if (result(); as res) {
          @if (res.imageUrls && res.imageUrls.length > 0) {
          <div class="grid grid-cols-4 gap-3">
            @for (url of res.imageUrls; track $index) {
            <div (click)="toggleImage($index)" class="relative cursor-pointer group rounded-lg overflow-hidden border-2 border-gray-200
                             hover:border-green-400 transition-all duration-200 hover:scale-105">

              <img [src]="`${env.apiUrl}/${url}`" [alt]="'Ảnh ' + ($index + 1)"
                class="w-full h-32 object-cover z-0 relative" />

              <!-- Hover overlay -->
              <div class="absolute inset-0 bg-black opacity-0 group-hover:opacity-10
                                  pointer-events-none transition-all z-10"></div>

              <!-- Selected checkmark -->
              @if (isImageSelected($index)) {
              <div class="absolute top-2 right-2 bg-green-500 rounded-full p-1 z-30">
                <app-icon name="check-circle" class="w-5 h-5 text-white" />
              </div>
              }

              <!-- Bottom gradient & label -->
              <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t
                                  from-black/60 to-transparent p-2 pointer-events-none z-20">
                <span class="text-white text-xs font-semibold">Ảnh {{ $index + 1 }}</span>
              </div>
            </div>
            }
          </div>
          } @else {
          <p class="text-gray-400 text-center py-4">Không có ảnh nào</p>
          }
          } @else {
          <p class="text-gray-400 text-center py-4">Không có ảnh nào</p>
          }
        </div>

        <!-- Text Section -->
        <div class="border-2 border-cyan-200 rounded-xl p-5 bg-gradient-to-br from-green-50 to-blue-100">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-2">
              <app-icon name="document-text" className="w-6 h-6 text-cyan-600" />
              <h3 class="font-bold text-gray-800 text-lg">Văn bản</h3>
              <span class="text-xs bg-white px-2 py-1 rounded-full text-gray-600">
                {{ selectedTextIndices().size }}/{{ getTextCount() }}
              </span>
            </div>
            <div class="flex space-x-2">
              <button (click)="selectAllTexts()"
                class="text-xs bg-cyan-500 text-white px-3 py-1 rounded-lg hover:bg-cyan-600 transition">
                Chọn tất cả
              </button>
              <button (click)="deselectAllTexts()"
                class="text-xs bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500 transition">
                Bỏ chọn
              </button>
            </div>
          </div>

          @if (result(); as res) {
          @if (res.processedTexts && res.processedTexts.length > 0) {
          <div class="grid grid-cols-3 gap-3">
            @for (item of res.processedTexts; track $index) {
            <div (click)="toggleText($index)" [class.ring-2]="isTextSelected($index)"
              [class.ring-cyan-500]="isTextSelected($index)" [class.bg-white]="isTextSelected($index)"
              [class.bg-gray-100]="!isTextSelected($index)" [class.opacity-50]="!isTextSelected($index)" class="relative cursor-pointer group p-4 rounded-lg border-2 border-gray-200
                             hover:border-cyan-400 transition-all duration-200 hover:scale-105"
              [title]="item.sentence">
              <div class="flex items-center justify-between">
                <div class="flex-1 min-w-0">
                  <p class="font-bold text-gray-800 truncate">{{ item.word }}</p>
                  <p class="text-xs text-gray-500 truncate mt-1">{{ item.sentence }}</p>
                </div>
                @if (isTextSelected($index)) {
                <app-icon name="check-circle" className="w-5 h-5 text-cyan-500 ml-2 flex-shrink-0" />
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <p class="text-gray-400 text-center py-4">Không có văn bản nào</p>
          }
          } @else {
          <p class="text-gray-400 text-center py-4">Không có văn bản nào</p>
          }
        </div>

        <!-- Audio Section (Hidden when missingAudio is true) -->
        @if (!missingAudio()) {
        <div class="border-2 border-blue-200 rounded-xl p-5 bg-gradient-to-br from-green-50 to-blue-100">
          <div class="flex justify-between items-center mb-4">
            <div class="flex items-center space-x-2">
              <app-icon name="music" className="w-6 h-6 text-blue-600" />
              <h3 class="font-bold text-gray-800 text-lg">Âm thanh</h3>
              <span class="text-xs bg-white px-2 py-1 rounded-full text-gray-600">
                {{ selectedAudioIndices().size }}/{{ getAudioCount() }}
              </span>
            </div>
            <div class="flex space-x-2">
              <button (click)="selectAllAudios()"
                class="text-xs bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition">
                Chọn tất cả
              </button>
              <button (click)="deselectAllAudios()"
                class="text-xs bg-gray-400 text-white px-3 py-1 rounded-lg hover:bg-gray-500 transition">
                Bỏ chọn
              </button>
            </div>
          </div>

          @if (result(); as res) {
          @if (res.audioUrls && res.audioUrls.length > 0) {
          <div class="grid grid-cols-2 gap-3">
            @for (url of res.audioUrls; track $index) {
            <div (click)="toggleAudio($index)" [class.ring-2]="isAudioSelected($index)"
              [class.ring-blue-500]="isAudioSelected($index)" [class.bg-white]="isAudioSelected($index)"
              [class.bg-gray-100]="!isAudioSelected($index)" [class.opacity-50]="!isAudioSelected($index)" class="relative cursor-pointer group p-4 rounded-lg border-2 border-gray-200
                               hover:border-blue-400 transition-all duration-200">
              <div class="flex items-center space-x-3">
                <div class="flex-shrink-0 bg-blue-500 rounded-full p-3">
                  <app-icon name="speaker-wave" className="w-6 h-6 text-white" />
                </div>
                <div class="flex-1 min-w-0">
                  <p class="font-semibold text-gray-800">Audio {{ $index + 1 }}</p>
                  <audio [src]="`${env.apiUrl}/${url}`" controls class="w-full mt-2"
                    (click)="$event.stopPropagation()"></audio>
                </div>
                @if (isAudioSelected($index)) {
                <app-icon name="check-circle" className="w-5 h-5 text-blue-500 flex-shrink-0" />
                }
              </div>
            </div>
            }
          </div>
          } @else {
          <p class="text-gray-400 text-center py-4">Không có âm thanh nào</p>
          }
          } @else {
          <p class="text-gray-400 text-center py-4">Không có âm thanh nào</p>
          }
        </div>
        }
      </div>

      <!-- Modal Footer -->
      <div
        class="sticky bottom-0 bg-white px-6 py-4 flex justify-between items-center rounded-b-2xl border-t border-gray-200">
        <div class="text-sm text-gray-600">
          Đã chọn: <span class="font-bold text-gray-800">{{ getSelectedCount() }}/{{ getTotalCount() }}</span> nút
        </div>
        <div class="flex space-x-3">
          <button (click)="selectAll()"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
            Chọn tất cả
          </button>
          <button (click)="deselectAll()"
            class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition font-medium">
            Bỏ chọn tất cả
          </button>
          <button (click)="closeModal()" class="px-6 py-2 bg-gradient-to-r from-green-300 to-blue-500 text-white rounded-lg
                     shadow-md hover:shadow-lg hover:from-green-500 hover:to-blue-700 transition font-semibold">
            Đóng
          </button>
        </div>
      </div>
    </div>
  </div>
  }
</div>
